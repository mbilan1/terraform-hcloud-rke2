# ──────────────────────────────────────────────────────────────────────────────
# Helmfile — declarative Helm chart deployment for Kubernetes addons
#
# DECISION: Helmfile over plain `helm install` scripts.
# Why: Declarative, idempotent, supports dependency ordering (needs:),
#      environment-specific overrides, and diff before apply.
#      Compatible with CI/CD pipelines and ArgoCD/Flux migration path.
# See: https://helmfile.readthedocs.io/
#
# DECISION: Separate from Terraform — Terraform manages L3 (infrastructure),
#      Helmfile manages L4 (Kubernetes workloads).
# Why: Helm values change frequently (tuning, versions). Terraform apply
#      risks touching infrastructure when only addon config changed.
#      GitOps tools (ArgoCD/Flux) can manage these charts natively.
# ──────────────────────────────────────────────────────────────────────────────

# NOTE: HCCM must be deployed FIRST after cluster bootstrap.
# Why: Nodes have the `node.cloudprovider.kubernetes.io/uninitialized` taint
#      until HCCM clears it. No other pods can schedule until HCCM runs.
#      Helmfile runs from the operator's machine (not inside the cluster),
#      so the taint does not block Helmfile itself.
# See: charts/hccm/README.md

repositories:
  - name: hetzner
    url: https://charts.hetzner.cloud
  - name: jetstack
    url: https://charts.jetstack.io
  - name: longhorn
    url: https://charts.longhorn.io
  - name: kubereboot
    url: https://kubereboot.github.io/charts
  - name: openedx
    url: https://openedx.github.io/openedx-k8s-harmony

releases:
  # ── HCCM (Hetzner Cloud Controller Manager) ────────────────────────────
  # DECISION: HCCM deployed via Helmfile, not cloud-init or Terraform.
  # Why: Keeps all L4 addon management in one tool (Helmfile/GitOps).
  #      Must be deployed first — nodes are unschedulable without it.
  - name: hccm
    namespace: kube-system
    chart: hetzner/hcloud-cloud-controller-manager
    version: "1.22.0"
    values:
      - hccm/values.yaml
    hooks:
      # Create the hcloud Secret before HCCM Helm release
      - events: ["presync"]
        showlogs: true
        command: "kubectl"
        args:
          - "apply"
          - "-f"
          - "hccm/manifests/"

  # ── cert-manager ────────────────────────────────────────────────────────
  # DECISION: Deploy cert-manager first — other addons depend on ClusterIssuer.
  - name: cert-manager
    namespace: cert-manager
    createNamespace: true
    chart: jetstack/cert-manager
    version: "v1.17.2"
    values:
      - cert-manager/values.yaml
    hooks:
      # NOTE: cert-manager CRDs must exist before ClusterIssuer can be created.
      # The chart installs CRDs when crds.enabled=true (see values.yaml).
      - events: ["postsync"]
        showlogs: true
        command: "kubectl"
        args:
          - "apply"
          - "-f"
          - "cert-manager/manifests/"

  # ── Longhorn ────────────────────────────────────────────────────────────
  # DECISION: Longhorn as primary storage driver (replaces Hetzner CSI).
  # Why: Replication across workers (HA). Local NVMe IOPS (~50K vs ~10K).
  #      VolumeSnapshot support. Native S3 backup.
  - name: longhorn
    namespace: longhorn-system
    createNamespace: true
    chart: longhorn/longhorn
    version: "1.8.1"
    needs:
      - cert-manager  # cert-manager CRDs needed if using cert-manager annotations
    values:
      - longhorn/values.yaml

  # ── Kured ───────────────────────────────────────────────────────────────
  # NOTE: Only useful on HA clusters (>=3 masters). On single-master, reboot
  # scheduling during maintenance is dangerous (etcd quorum loss).
  - name: kured
    namespace: kured
    createNamespace: true
    chart: kubereboot/kured
    version: "5.6.0"
    values:
      - kured/values.yaml

  # ── Harmony (Open edX) ─────────────────────────────────────────────────
  # NOTE: Optional — only deploy when running Open edX workloads.
  # Comment out or remove this release if not using Open edX.
  #
  # DECISION: Harmony depends on cert-manager + longhorn.
  # Why: Harmony workloads need TLS certificates and persistent storage.
  - name: harmony
    namespace: harmony
    createNamespace: true
    chart: openedx/harmony-chart
    # version: ""  # Uncomment and pin when needed
    needs:
      - cert-manager
      - longhorn
    values:
      - harmony/values.yaml
