This repository contains an independently maintained Terraform/OpenTofu module.

Acknowledgements / Upstream

- This project originally started from the upstream module:
  https://github.com/wenzel-felix/terraform-hcloud-rke2
- The divergence began from upstream release v0.6.1 (Jan 23, 2025).
  Since then the codebase has been extensively rewritten and has diverged
  architecturally from the upstream (see docs/ARCHITECTURE.md for details).
- The Git history was reset to begin from the first independent release
  (commit b5a31c6, "feat: initial release"). Upstream commit history is
  not preserved in this repository; the upstream repository remains
  available at its original URL.
- Credit for the original baseline work belongs to the upstream author and
  contributors.

License notes

- This repository is distributed under the MIT License (see LICENSE).
- For clarity, the upstream MIT license text is preserved in:
  LICENSES/LicenseRef-MIT-upstream-wenzel-felix.txt

Upstream-derived patterns

The following files contain small code patterns derived from the upstream
module (wenzel-felix/terraform-hcloud-rke2, MIT). Each pattern is marked
with an inline comment in the source code. The surrounding code in these
files is independently written.

  C1. Hetzner metadata IP detection pipeline
      Files: modules/infrastructure/scripts/rke-master.sh.tpl  (line ~15)
             modules/infrastructure/scripts/rke-worker.sh.tpl  (line ~15)
      Pattern:
        curl ... http://169.254.169.254/hetzner/v1/metadata/private-networks
          | grep "ip:" | cut -f 3 -d" "
      Notes: The metadata URL is standard Hetzner API, but the specific
        grep+cut parsing pipeline is from upstream. Our version adds
        --connect-timeout 5, || true error handling, and while-loop retry.

  C2. Kubeconfig fetch via tenstad/remote provider
      File:  modules/infrastructure/readiness.tf  (lines ~150-170)
      Pattern:
        data "remote_file" "kubeconfig" {
          conn { sudo = true; timeout = 500 }
          path = "/etc/rancher/rke2/rke2.yaml"
        }
      Notes: Resource name "kubeconfig", provider choice (tenstad/remote),
        sudo = true, and non-default timeout = 500 match upstream. Host
        source and dependency chain are independently implemented.

  C3. Cluster join token: random_password length = 48
      File:  modules/infrastructure/main.tf  (lines ~19-22)
      Pattern:
        resource "random_password" "..." { length = 48; special = false }
      Notes: RKE2 requires a token but does not prescribe length. The value
        48 is a specific design choice from upstream. Resource renamed from
        "rke2_token" to "cluster_join_secret".

  C4. Server lifecycle block: ignore_changes triple
      File:  modules/infrastructure/main.tf  (lines ~127, ~181, ~239)
      Pattern:
        lifecycle {
          ignore_changes = [user_data, image, server_type]
          create_before_destroy = true
        }
      Notes: The [user_data, image, server_type] + create_before_destroy
        combination is from upstream. Our version extends to a 4-tuple by
        adding 'labels'. Applied to all three server resources (master-0,
        additional masters, workers).

  C5. cluster_configuration variable schema (partial)
      File:  variables.tf  (lines ~43-167)
      Pattern:
        variable "cluster_configuration" { type = object({
          hcloud_controller = optional(object({ preinstall, version }))
          cert_manager = optional(object({ preinstall, version,
            use_for_preinstalled_components }))
          self_maintenance = optional(object({
            system_upgrade_controller_version }))
        })}
      Notes: Variable name, nested key names, and some default values
        (hcloud_controller.version = "1.19.0",
        system_upgrade_controller_version = "0.13.4") originate from
        upstream. Extensively extended with 5 new subsections (hcloud_csi,
        etcd_backup, longhorn, release_name/namespace metadata), 20
        validation blocks, and redesigned type structure.
